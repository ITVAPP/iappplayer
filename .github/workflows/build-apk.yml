name: Find Android v1 Embedding Problem Files
on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
      
      # ç«‹å³æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„é—®é¢˜æ–‡ä»¶
      - name: Aggressive File Analysis
        run: |
          echo "=== ğŸ” å¼€å§‹å…¨é¢æ–‡ä»¶æ£€æŸ¥ ==="
          cd example
          
          echo "=== ğŸ“ é¡¹ç›®ç»“æ„ ==="
          find . -name "android" -type d
          find . -path "*/android/app/src/main/java*" -type d 2>/dev/null || echo "æ— Javaç›®å½•"
          find . -name "*.java" -o -name "*.kt" | head -10
          
          echo ""
          echo "=== ğŸ“± MainActivityæ–‡ä»¶è¯¦ç»†åˆ†æ ==="
          MAIN_ACTIVITIES=$(find . -name "*MainActivity*" -type f 2>/dev/null)
          
          if [ -z "$MAIN_ACTIVITIES" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°MainActivityæ–‡ä»¶"
          else
            for file in $MAIN_ACTIVITIES; do
              echo ""
              echo "ğŸ” åˆ†ææ–‡ä»¶: $file"
              echo "--- å®Œæ•´å†…å®¹ ---"
              cat "$file"
              echo ""
              echo "--- v1 Embeddingæ£€æŸ¥ ---"
              if grep -q "io.flutter.app.FlutterActivity" "$file"; then
                echo "ğŸš¨ å‘ç°v1 FlutterActivityå¯¼å…¥!"
                grep -n "io.flutter.app.FlutterActivity" "$file"
              fi
              if grep -q "GeneratedPluginRegistrant" "$file"; then
                echo "ğŸš¨ å‘ç°GeneratedPluginRegistrantä½¿ç”¨!"
                grep -n "GeneratedPluginRegistrant" "$file"
              fi
              if grep -q "registerWith" "$file"; then
                echo "ğŸš¨ å‘ç°registerWithè°ƒç”¨!"
                grep -n "registerWith" "$file"
              fi
              echo "=================="
            done
          fi
          
          echo ""
          echo "=== ğŸ“‹ AndroidManifest.xmlæ–‡ä»¶åˆ†æ ==="
          MANIFESTS=$(find . -name "AndroidManifest.xml" -type f 2>/dev/null)
          
          if [ -z "$MANIFESTS" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°AndroidManifest.xmlæ–‡ä»¶"
          else
            for file in $MANIFESTS; do
              echo ""
              echo "ğŸ” åˆ†ææ–‡ä»¶: $file"
              echo "--- å®Œæ•´å†…å®¹ ---"
              cat "$file"
              echo ""
              echo "--- Embeddingé…ç½®æ£€æŸ¥ ---"
              if grep -q "flutterEmbedding" "$file"; then
                echo "âœ… å‘ç°flutterEmbeddingé…ç½®"
                grep -n "flutterEmbedding" "$file"
              else
                echo "ğŸš¨ ç¼ºå°‘flutterEmbeddingé…ç½®!"
              fi
              echo "=================="
            done
          fi
          
          echo ""
          echo "=== ğŸ” å…¨é¡¹ç›®v1å…³é”®è¯æœç´¢ ==="
          echo "--- æœç´¢ 'io.flutter.app' ---"
          grep -r "io.flutter.app" . 2>/dev/null && echo "ğŸš¨ å‘ç°v1å¯¼å…¥!" || echo "âœ… æœªå‘ç°v1å¯¼å…¥"
          
          echo "--- æœç´¢ 'GeneratedPluginRegistrant.registerWith' ---"
          grep -r "GeneratedPluginRegistrant.registerWith" . 2>/dev/null && echo "ğŸš¨ å‘ç°v1æ³¨å†Œæ–¹å¼!" || echo "âœ… æœªå‘ç°v1æ³¨å†Œæ–¹å¼"
          
          echo "--- æœç´¢ 'FlutterApplication' ---"
          grep -r "FlutterApplication" . 2>/dev/null && echo "ğŸš¨ å‘ç°FlutterApplication!" || echo "âœ… æœªå‘ç°FlutterApplication"
          
          echo ""
          echo "=== ğŸ“Š ç»“è®º ==="
          echo "å¦‚æœä¸Šé¢æ˜¾ç¤ºäº†ğŸš¨æ ‡è®°ï¼Œé‚£å°±æ˜¯éœ€è¦ä¿®å¤çš„v1 embeddingé—®é¢˜æ–‡ä»¶ï¼"
      
      # è·å–ä¾èµ–
      - name: Get Dependencies
        run: |
          flutter pub get
          cd example && flutter pub get
      
      # å°è¯•æ„å»ºçœ‹å…·ä½“é”™è¯¯
      - name: Attempt Build
        continue-on-error: true
        run: |
          cd example
          echo "=== ğŸš€ å°è¯•æ„å»ºï¼ˆé¢„æœŸå¤±è´¥ï¼‰==="
          flutter build apk --release --verbose 2>&1 | tee ../build_log.txt
          echo "æ„å»ºé€€å‡ºç : $?"
      
      # ä¸Šä¼ æ‰€æœ‰æ—¥å¿—
      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: embedding-analysis-results
          path: |
            build_log.txt
